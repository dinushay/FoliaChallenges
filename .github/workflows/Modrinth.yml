name: Build and Publish to Modrinth

on:
  push:
    branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Build with Gradle
      run: ./gradlew build

    - name: Prepare Metadata
      id: meta
      run: |
        echo "UNIX_TIME=$(date +%s)" >> $GITHUB_ENV
        
        VERSION=$(grep "^version:" app/src/main/resources/plugin.yml | awk '{print $2}')
        VERSION=$(echo "$VERSION" | tr -d "'\"")
        
        if [ -z "$VERSION" ]; then
             VERSION="1.0"
        fi
        echo "PROJECT_VERSION=$VERSION" >> $GITHUB_ENV
        
        RAW_TITLE=$(git log -1 --pretty=%s)
        SHORT_TITLE=$(echo "$RAW_TITLE" | cut -c 1-64)
        echo "COMMIT_TITLE=$SHORT_TITLE" >> $GITHUB_ENV
        
        EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
        
        echo "COMMIT_BODY<<$EOF" >> $GITHUB_ENV
        
        echo "## $RAW_TITLE" >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        git log -1 --pretty=%b >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        
        SHA=$(git rev-parse HEAD)
        echo "---" >> $GITHUB_ENV
        echo "ðŸ¤– *This release was automatically created by a [commit](https://github.com/dinushay/FoliaChallenges/commit/$SHA) on the [GitHub Page](https://github.com/dinushay/FoliaChallenges).*" >> $GITHUB_ENV
        
        echo "$EOF" >> $GITHUB_ENV

    - name: Modrinth Publish
      uses: cloudnode-pro/modrinth-publish@v2.1.7
      with:
        token: ${{ secrets.MODRINTH_TOKEN }}
        project: 'QSSFb4tn'
        name: ${{ env.COMMIT_TITLE }}
        
        version: ${{ env.PROJECT_VERSION }}.${{ env.UNIX_TIME }}
        
        channel: 'alpha'
        changelog: ${{ env.COMMIT_BODY }}
        loaders: '["folia"]'
        game-versions: '["1.21.8", "1.21.9", "1.21.10", "1.21.11"]'
        files: '["app/build/libs/FoliaChallenges.jar"]'
