name: Build and Publish to Modrinth

on:
  push:
    branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Required for git log to work

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Build with Gradle
      run: ./gradlew build

    - name: Prepare Metadata
      id: meta
      run: |
        echo "UNIX_TIME=$(date +%s)" >> $GITHUB_ENV
        
        VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
        echo "PROJECT_VERSION=$VERSION" >> $GITHUB_ENV
        
        echo "COMMIT_TITLE=$(git log -1 --pretty=%s)" >> $GITHUB_ENV
        
        EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
        echo "COMMIT_BODY<<$EOF" >> $GITHUB_ENV
        git log -1 --pretty=%b >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "---" >> $GITHUB_ENV
        echo "ðŸ¤– *This release was automatically created by a commit on GitHub.*" >> $GITHUB_ENV
        echo "$EOF" >> $GITHUB_ENV

    - name: Modrinth Publish
      uses: cloudnode-pro/modrinth-publish@v2.1.7
      with:
        token: ${{ secrets.MODRINTH_TOKEN }}
        project: 'QSSFb4tn'
        name: ${{ env.COMMIT_TITLE }}
        version: ${{ env.PROJECT_VERSION }}.${{ env.UNIX_TIME }}
        channel: 'alpha'
        changelog: ${{ env.COMMIT_BODY }}
        loaders: |
          folia
        game-versions: |
          1.21.8
          1.21.9
          1.21.10
          1.21.11
        
        files: '["app/build/libs/FoliaChallenges.jar"]'
